[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2026-01-31 15:08:49.697841",
  "module": "Cecypo PowerPack",
  "name": "Price List Bulk Editor",
  "script": "// Client Script for Item DocType (List View)\n// Script Type: List\n// DocType: Item\n\nfrappe.listview_settings['Item'] = frappe.listview_settings['Item'] || {};\n\nfrappe.listview_settings['Item'].onload = function(listview) {\n    listview.page.add_action_item(__('Bulk Price Update'), function() {\n        const selected = listview.get_checked_items();\n        if (!selected.length) {\n            frappe.msgprint(__('Please select at least one item'));\n            return;\n        }\n        \n        const item_codes = selected.map(d => d.name);\n        show_bulk_price_dialog(item_codes);\n    });\n};\n\nfunction show_bulk_price_dialog(item_codes) {\n    const dialog = new frappe.ui.Dialog({\n        title: __('Bulk Price Update'),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldname: 'controls_html',\n                fieldtype: 'HTML'\n            },\n            {\n                fieldname: 'items_html',\n                fieldtype: 'HTML'\n            }\n        ],\n        primary_action_label: __('Save Prices'),\n        primary_action: function() {\n            save_prices(dialog);\n        }\n    });\n    \n    dialog.item_codes = item_codes;\n    dialog.items_data = [];\n    \n    render_controls(dialog);\n    dialog.show();\n    render_items_table(dialog, []);\n}\n\nfunction render_controls(dialog) {\n    const html = `\n        <div class=\"bulk-price-controls\" style=\"display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);\">\n            <div class=\"control-group\" style=\"flex: 1; min-width: 140px;\">\n                <label class=\"control-label\" style=\"font-size: 11px; color: var(--text-muted); margin-bottom: 2px; display: block;\">Buying Price List *</label>\n                <select class=\"form-control form-control-sm buying-pl-select\" style=\"height: 30px; font-size: 12px;\"></select>\n            </div>\n            <div class=\"control-group\" style=\"flex: 1; min-width: 140px;\">\n                <label class=\"control-label\" style=\"font-size: 11px; color: var(--text-muted); margin-bottom: 2px; display: block;\">Selling Price List *</label>\n                <select class=\"form-control form-control-sm selling-pl-select\" style=\"height: 30px; font-size: 12px;\"></select>\n            </div>\n            <div class=\"control-group\" style=\"width: 85px;\">\n                <label class=\"control-label\" style=\"font-size: 11px; color: var(--text-muted); margin-bottom: 2px; display: block;\">Type</label>\n                <select class=\"form-control form-control-sm calc-type-select\" style=\"height: 30px; font-size: 12px;\">\n                    <option value=\"markup\">Markup</option>\n                    <option value=\"margin\">Margin</option>\n                </select>\n            </div>\n            <div class=\"control-group\" style=\"width: 70px;\">\n                <label class=\"control-label calc-percent-label\" style=\"font-size: 11px; color: var(--text-muted); margin-bottom: 2px; display: block;\">Markup %</label>\n                <input type=\"number\" class=\"form-control form-control-sm calc-percent-input\" value=\"0\" step=\"0.1\" style=\"height: 30px; font-size: 12px;\">\n            </div>\n            <div class=\"control-group\" style=\"width: 90px;\">\n                <label class=\"control-label\" style=\"font-size: 11px; color: var(--text-muted); margin-bottom: 2px; display: block;\">Round To</label>\n                <select class=\"form-control form-control-sm round-select\" style=\"height: 30px; font-size: 12px;\">\n                    <option value=\"0\">None</option>\n                    <option value=\"1\">1</option>\n                    <option value=\"5\">5</option>\n                    <option value=\"10\">10</option>\n                    <option value=\"50\">50</option>\n                    <option value=\"100\">100</option>\n                    <option value=\"500\">500</option>\n                    <option value=\"1000\">1000</option>\n                </select>\n            </div>\n            <div class=\"control-group\">\n                <button class=\"btn btn-xs btn-primary apply-calc-btn\" style=\"height: 30px; padding: 0 12px; font-size: 12px;\">\n                    Apply\n                </button>\n            </div>\n        </div>\n    `;\n    \n    dialog.fields_dict.controls_html.$wrapper.html(html);\n    load_price_lists(dialog);\n    \n    const $controls = dialog.fields_dict.controls_html.$wrapper;\n    \n    $controls.find('.buying-pl-select, .selling-pl-select').on('change', function() {\n        refresh_prices(dialog);\n    });\n    \n    // Update label when calc type changes\n    $controls.find('.calc-type-select').on('change', function() {\n        const type = $(this).val();\n        const label = type === 'markup' ? 'Markup %' : 'Margin %';\n        $controls.find('.calc-percent-label').text(label);\n        // Update table header and recalculate displayed percentages\n        update_table_header(dialog);\n        recalculate_percentages(dialog);\n    });\n    \n    $controls.find('.apply-calc-btn').on('click', function() {\n        apply_calculation_to_all(dialog);\n    });\n}\n\nfunction load_price_lists(dialog) {\n    const $controls = dialog.fields_dict.controls_html.$wrapper;\n    \n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Price List',\n            filters: { buying: 1, enabled: 1 },\n            fields: ['name'],\n            limit_page_length: 0\n        },\n        async: false,\n        callback: function(r) {\n            const $select = $controls.find('.buying-pl-select');\n            $select.html('<option value=\"\">Select...</option>');\n            (r.message || []).forEach(pl => {\n                $select.append(`<option value=\"${pl.name}\">${pl.name}</option>`);\n            });\n        }\n    });\n    \n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Price List',\n            filters: { selling: 1, enabled: 1 },\n            fields: ['name'],\n            limit_page_length: 0\n        },\n        async: false,\n        callback: function(r) {\n            const $select = $controls.find('.selling-pl-select');\n            $select.html('<option value=\"\">Select...</option>');\n            (r.message || []).forEach(pl => {\n                $select.append(`<option value=\"${pl.name}\">${pl.name}</option>`);\n            });\n        }\n    });\n}\n\nfunction get_control_values(dialog) {\n    const $controls = dialog.fields_dict.controls_html.$wrapper;\n    return {\n        buying_price_list: $controls.find('.buying-pl-select').val(),\n        selling_price_list: $controls.find('.selling-pl-select').val(),\n        calc_type: $controls.find('.calc-type-select').val(),\n        calc_percent: parseFloat($controls.find('.calc-percent-input').val()) || 0,\n        round_to: parseInt($controls.find('.round-select').val()) || 0\n    };\n}\n\nfunction refresh_prices(dialog) {\n    const values = get_control_values(dialog);\n    \n    if (!values.buying_price_list || !values.selling_price_list) return;\n    \n    dialog.fields_dict.items_html.$wrapper.html(`\n        <div class=\"text-center text-muted py-5\">\n            <i class=\"fa fa-spinner fa-spin fa-2x\"></i>\n            <p class=\"mt-2\">${__('Loading prices...')}</p>\n        </div>\n    `);\n    \n    frappe.call({\n        method: 'fetch_item_prices',\n        args: {\n            item_codes_str: dialog.item_codes.join('|||'),\n            buying_price_list: values.buying_price_list,\n            selling_price_list: values.selling_price_list\n        },\n        callback: function(r) {\n            dialog.items_data = r.message || [];\n            render_items_table(dialog, dialog.items_data);\n        },\n        error: function(err) {\n            frappe.msgprint(__('Error fetching prices'));\n            render_items_table(dialog, []);\n        }\n    });\n}\n\nfunction update_table_header(dialog) {\n    const values = get_control_values(dialog);\n    const label = values.calc_type === 'markup' ? __('Markup') : __('Margin');\n    dialog.fields_dict.items_html.$wrapper.find('.percent-header').text(label);\n}\n\nfunction recalculate_percentages(dialog) {\n    const values = get_control_values(dialog);\n    const $wrapper = dialog.fields_dict.items_html.$wrapper;\n    \n    dialog.items_data.forEach((item, idx) => {\n        const cost = item.cost_price || 0;\n        const sell = item.sell_price || 0;\n        const pct = calculate_percentage(cost, sell, values.calc_type);\n        \n        $wrapper.find(`.percent-display[data-idx=\"${idx}\"]`).html(\n            `<span class=\"${get_percent_class(pct)}\">${pct}%</span>`\n        );\n    });\n}\n\n// Calculate markup or margin percentage from cost and sell prices\nfunction calculate_percentage(cost, sell, calc_type) {\n    if (calc_type === 'markup') {\n        // Markup % = ((Sell - Cost) / Cost) × 100\n        return cost > 0 ? (((sell - cost) / cost) * 100).toFixed(1) : '—';\n    } else {\n        // Margin % = ((Sell - Cost) / Sell) × 100\n        return sell > 0 ? (((sell - cost) / sell) * 100).toFixed(1) : '—';\n    }\n}\n\n// Calculate sell price from cost and percentage\nfunction calculate_sell_price(cost, percent, calc_type) {\n    if (calc_type === 'markup') {\n        // Sell = Cost × (1 + Markup%/100)\n        return cost * (1 + percent / 100);\n    } else {\n        // Sell = Cost / (1 - Margin%/100)\n        // Guard against margin >= 100%\n        if (percent >= 100) return cost * 10; // Cap at 10x\n        return cost / (1 - percent / 100);\n    }\n}\n\nfunction render_items_table(dialog, items) {\n    const currency = frappe.boot.sysdefaults.currency || 'KES';\n    const values = get_control_values(dialog);\n    const pctLabel = values.calc_type === 'markup' ? __('Markup') : __('Margin');\n    \n    let html = `\n        <div class=\"bulk-price-table-container\" style=\"max-height: calc(100vh - 280px); overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;\">\n            <table class=\"table table-sm\" style=\"margin-bottom: 0; font-size: 12px;\">\n                <thead style=\"position: sticky; top: 0; background: var(--subtle-fg); z-index: 1;\">\n                    <tr>\n                        <th style=\"width: 35px; text-align: center; padding: 8px 4px;\">\n                            <input type=\"checkbox\" class=\"select-all-items\" checked>\n                        </th>\n                        <th style=\"padding: 8px 6px;\">${__('Item Code')}</th>\n                        <th style=\"padding: 8px 6px;\">${__('Item Name')}</th>\n                        <th style=\"width: 100px; text-align: right; padding: 8px 6px;\">${__('Cost')}</th>\n                        <th style=\"width: 120px; text-align: right; padding: 8px 6px;\">${__('Sell Price')}</th>\n                        <th style=\"width: 70px; text-align: right; padding: 8px 6px;\" class=\"percent-header\">${pctLabel}</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    if (!items.length) {\n        html += `\n            <tr>\n                <td colspan=\"6\" class=\"text-center text-muted py-4\">\n                    ${__('Select both price lists to load prices')}\n                </td>\n            </tr>\n        `;\n    } else {\n        items.forEach((item, idx) => {\n            const pct = calculate_percentage(item.cost_price, item.sell_price, values.calc_type);\n            \n            html += `\n                <tr data-idx=\"${idx}\">\n                    <td style=\"text-align: center; padding: 6px 4px;\">\n                        <input type=\"checkbox\" class=\"item-checkbox\" data-idx=\"${idx}\" checked>\n                    </td>\n                    <td style=\"padding: 6px;\">\n                        <a href=\"/app/item/${item.item_code}\" target=\"_blank\" style=\"color: var(--text-color); font-weight: 500;\">\n                            ${item.item_code}\n                        </a>\n                    </td>\n                    <td style=\"padding: 6px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\" title=\"${item.item_name || ''}\">\n                        ${item.item_name || ''}\n                    </td>\n                    <td style=\"text-align: right; padding: 6px; color: var(--text-muted);\">\n                        ${format_currency(item.cost_price, currency)}\n                    </td>\n                    <td style=\"text-align: right; padding: 4px 6px;\">\n                        <input type=\"number\" \n                               class=\"form-control form-control-sm sell-price-input\" \n                               data-idx=\"${idx}\"\n                               value=\"${item.sell_price || 0}\"\n                               step=\"0.01\"\n                               style=\"width: 100px; text-align: right; display: inline-block; height: 26px; font-size: 12px;\">\n                    </td>\n                    <td style=\"text-align: right; padding: 6px;\" class=\"percent-display\" data-idx=\"${idx}\">\n                        <span class=\"${get_percent_class(pct)}\">${pct}%</span>\n                    </td>\n                </tr>\n            `;\n        });\n    }\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n        <div class=\"mt-2 d-flex justify-content-between align-items-center\" style=\"font-size: 11px; color: var(--text-muted);\">\n            <span><span class=\"selected-count\">${items.length}</span>/${items.length} selected</span>\n            <span>Total: <strong>${items.length}</strong> items</span>\n        </div>\n    `;\n    \n    dialog.fields_dict.items_html.$wrapper.html(html);\n    bind_table_events(dialog);\n}\n\nfunction bind_table_events(dialog) {\n    const $wrapper = dialog.fields_dict.items_html.$wrapper;\n    \n    $wrapper.find('.select-all-items').off('change').on('change', function() {\n        const checked = $(this).is(':checked');\n        $wrapper.find('.item-checkbox').prop('checked', checked);\n        update_selected_count(dialog);\n    });\n    \n    $wrapper.find('.item-checkbox').off('change').on('change', function() {\n        update_selected_count(dialog);\n        const total = $wrapper.find('.item-checkbox').length;\n        const checked = $wrapper.find('.item-checkbox:checked').length;\n        $wrapper.find('.select-all-items').prop('checked', total === checked);\n    });\n    \n    $wrapper.find('.sell-price-input').off('input').on('input', function() {\n        const idx = $(this).data('idx');\n        const new_price = parseFloat($(this).val()) || 0;\n        const values = get_control_values(dialog);\n        \n        dialog.items_data[idx].sell_price = new_price;\n        \n        const cost = dialog.items_data[idx].cost_price || 0;\n        const pct = calculate_percentage(cost, new_price, values.calc_type);\n        \n        $wrapper.find(`.percent-display[data-idx=\"${idx}\"]`).html(\n            `<span class=\"${get_percent_class(pct)}\">${pct}%</span>`\n        );\n    });\n}\n\nfunction update_selected_count(dialog) {\n    const $wrapper = dialog.fields_dict.items_html.$wrapper;\n    const checked = $wrapper.find('.item-checkbox:checked').length;\n    $wrapper.find('.selected-count').text(checked);\n}\n\nfunction apply_calculation_to_all(dialog) {\n    const values = get_control_values(dialog);\n    \n    if (!dialog.items_data.length) {\n        frappe.msgprint(__('No items loaded. Please select both price lists first.'));\n        return;\n    }\n    \n    const $wrapper = dialog.fields_dict.items_html.$wrapper;\n    let updated = 0;\n    \n    dialog.items_data.forEach((item, idx) => {\n        if (!$wrapper.find(`.item-checkbox[data-idx=\"${idx}\"]`).is(':checked')) return;\n        \n        const cost = item.cost_price || 0;\n        let new_price = calculate_sell_price(cost, values.calc_percent, values.calc_type);\n        \n        if (values.round_to > 0) {\n            new_price = Math.ceil(new_price / values.round_to) * values.round_to;\n        }\n        \n        item.sell_price = new_price;\n        $wrapper.find(`.sell-price-input[data-idx=\"${idx}\"]`).val(new_price.toFixed(2));\n        \n        const actual_pct = calculate_percentage(cost, new_price, values.calc_type);\n        \n        $wrapper.find(`.percent-display[data-idx=\"${idx}\"]`).html(\n            `<span class=\"${get_percent_class(actual_pct)}\">${actual_pct}%</span>`\n        );\n        updated++;\n    });\n    \n    const typeLabel = values.calc_type === 'markup' ? __('Markup') : __('Margin');\n    frappe.show_alert({ message: __('{0} applied to {1} items', [typeLabel, updated]), indicator: 'green' }, 3);\n}\n\nfunction save_prices(dialog) {\n    const values = get_control_values(dialog);\n    \n    if (!values.selling_price_list) {\n        frappe.msgprint(__('Please select a Selling Price List'));\n        return;\n    }\n    \n    const $wrapper = dialog.fields_dict.items_html.$wrapper;\n    const items_to_update = [];\n    \n    dialog.items_data.forEach((item, idx) => {\n        if ($wrapper.find(`.item-checkbox[data-idx=\"${idx}\"]`).is(':checked')) {\n            items_to_update.push(\n                item.item_code + '::' + (parseFloat($wrapper.find(`.sell-price-input[data-idx=\"${idx}\"]`).val()) || 0)\n            );\n        }\n    });\n    \n    if (!items_to_update.length) {\n        frappe.msgprint(__('No items selected for update'));\n        return;\n    }\n    \n    dialog.disable_primary_action();\n    \n    frappe.call({\n        method: 'save_item_prices',\n        args: {\n            items_str: items_to_update.join('|||'),\n            selling_price_list: values.selling_price_list\n        },\n        callback: function(r) {\n            if (r.message) {\n                frappe.show_alert({\n                    message: __('Updated {0} prices', [r.message.updated_count]),\n                    indicator: 'green'\n                }, 5);\n                dialog.hide();\n            }\n        },\n        error: function() {\n            frappe.msgprint(__('Error saving prices'));\n        },\n        always: function() {\n            dialog.enable_primary_action();\n        }\n    });\n}\n\nfunction format_currency(value, currency) {\n    if (value === null || value === undefined || value === 0) return '—';\n    return frappe.format(value, { fieldtype: 'Currency', currency: currency });\n}\n\nfunction get_percent_class(pct) {\n    if (pct === '—') return 'text-muted';\n    const p = parseFloat(pct);\n    if (p < 0) return 'text-danger';\n    if (p < 10) return 'text-warning';\n    if (p < 20) return 'text-info';\n    return 'text-success';\n}",
  "view": "List"
 }
]